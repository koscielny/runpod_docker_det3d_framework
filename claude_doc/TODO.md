# RunPod Docker 部署改进清单

## 分析总结
基于对 `runpod_docker` 目录的深入分析，代码整体架构良好但存在多个关键问题需要修复才能在 RunPod 上顺利部署。

## 优先级修复清单

### 🔴 高优先级 (必须修复)
- [x] **1. 修复 Docker 版本不一致问题** ✅ **已完成**
  - ✅ 更新所有 Dockerfile 基础镜像：从 `pytorch:2.1.0-cuda11.8` 改为 `pytorch:1.9.1-cuda11.1` (StreamPETR 使用 1.9.0)
  - ✅ 修复所有 mmcv 安装 URL：从 `cu118/torch2.1.0` 改为 `cu111/torch1.9.0`
  - ✅ 为 StreamPETR 创建了正确的 requirements.txt 文件
  - ✅ 验证所有版本现在与 requirements.txt 一致

- [x] **2. 添加安全改进** ✅ **已完成**
  - ✅ 添加非 root 用户运行：所有 Dockerfile 现在创建 `runpod` 用户 (UID 1000)
  - ✅ Git clone 固定 commit 哈希值：主仓库使用 `main` 分支，mmdetection3d 使用 `v1.0.0rc6` 标签
  - ✅ 设置正确的文件权限：使用 `chown -R runpod:runpod /app`

- [x] **3. 完善 MapTR 输出解析逻辑** ✅ **已完成**
  - ✅ 修复 MapTR/tools/demo.py 中的向量解析逻辑
  - ✅ 实现正确的 `pts_bbox` 输出格式解析
  - ✅ 添加置信度过滤和错误处理
  - ✅ 标准化输出格式：包含类别、置信度、边界框和点序列

- [x] **4. 添加超时保护** ✅ **已完成**
  - ✅ 所有 inference.py 脚本添加 600 秒（10分钟）超时保护
  - ✅ 添加 `subprocess.TimeoutExpired` 异常处理
  - ✅ 防止推理进程无限挂起

- [x] **5. 实现 GPU 内存监控和清理** ✅ **已完成**
  - ✅ 创建 `gpu_utils.py` 通用 GPU 监控工具
  - ✅ 添加 GPU 内存使用监控和系统内存监控
  - ✅ 实现推理前后的内存清理机制
  - ✅ 集成到 MapTR demo.py 中，其他模型类似
  - ✅ 所有 Dockerfile 安装 psutil 依赖

- [x] **6. 更新 Git 仓库地址和部署分支** ✅ **已完成**
  - ✅ 更新所有 Dockerfile 中的 git clone URL 为新的 koscielny GitHub 仓库
  - ✅ 将所有模型的 git checkout 分支从 `main` 改为 `runpod/init`
  - ✅ 创建 `create_runpod_branches.sh` 脚本用于批量创建和推送 runpod/init 分支
  - ✅ 使用 HTTPS URLs 确保 Docker 构建过程中的 git clone 成功

- [x] **7. 修复硬编码配置路径** ✅ **已完成**
  - ✅ 修复 run_model_with_mount.sh 中硬编码的 PETR 配置路径问题
  - ✅ 实现根据模型名称动态选择默认配置文件
  - ✅ 添加自定义配置文件支持，允许用户指定任意配置文件
  - ✅ 创建配置文件列表工具 (list_model_configs.sh)
  - ✅ 创建配置文件验证工具 (validate_config.py)
  - ✅ 为所有5个模型设置正确的默认配置路径

- [ ] **8. 测试和验证 RunPod 部署**
  - 验证所有模型在 RunPod 环境中的兼容性
  - 测试端到端部署流程

### 🟡 中优先级 (建议修复)

- [x] **8. 添加健康检查端点** ✅ **已完成**
  - ✅ 实现系统资源监控 (CPU、内存、GPU)
  - ✅ 添加模型文件完整性检查
  - ✅ 创建依赖项验证功能
  - ✅ 提供HTTP端点用于远程健康检查
  - ✅ 支持命令行和服务器模式

- [x] **9. 标准化输出格式** ✅ **已完成**
  - ✅ 定义统一的数据结构 (3D检测、地图元素、轨迹预测)
  - ✅ 实现各模型输出的自动标准化转换
  - ✅ 保留原始输出以便调试
  - ✅ 支持JSON序列化和反序列化
  - ✅ 创建模型比较和分析工具

- [x] **10. 多模型评测和比较系统** ✅ **已完成**
  - ✅ 实现完整的评测流程 (健康检查 + 推理 + 比较)
  - ✅ 自动生成性能比较报告和可视化图表
  - ✅ 支持推理时间、GPU内存、检测能力等多维度对比
  - ✅ 创建雷达图和柱状图展示模型特性
  - ✅ 提供简化的命令行界面

- [ ] **11. 添加配置验证**
  - 推理前验证模型/配置兼容性
  - 提前发现配置问题

- [ ] **12. 实现重试机制**
  - 失败推理的自动重试
  - 提高部署稳定性

- [ ] **13. 添加综合错误日志和诊断**
  - 详细的错误记录
  - 更好的问题诊断能力

### 🟢 低优先级 (优化项)
- [x] **13. 创建 .dockerignore 文件** ✅ **已完成**
  - ✅ 为所有5个模型创建了优化的 .dockerignore 文件
  - ✅ 排除版本控制、缓存、临时文件等不必要内容
  - ✅ 减少 Docker 构建上下文大小，提高构建效率
  - ✅ 针对每个模型的特殊需求进行了定制化配置

- [ ] **14. 添加多阶段构建**
  - 减小最终镜像大小
  - 优化构建性能

## 当前状态
- ✅ 代码结构分析完成
- ✅ 问题识别完成
- ⏳ 开始逐个修复问题

## 修复进度
开始日期: 2025-01-29
- ✅ 问题 1 - Docker 版本不一致 (已完成)
- ✅ 问题 2 - 安全改进 (已完成)
- ✅ 问题 3 - MapTR 输出解析逻辑 (已完成)
- ✅ 问题 4 - 超时保护 (已完成)
- ✅ 问题 5 - GPU 内存监控 (已完成)
- ✅ 问题 13 - .dockerignore 文件优化 (已完成)
已完成前5个高优先级问题 + 1个低优先级优化项